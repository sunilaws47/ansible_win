  - name: Reboot usecase
    hosts: dev
    tasks:
    - wait_for_connection:
        timeout: 15
      register: connection
      ignore_errors: true
      delegate_to: localhost

    - debug: msg="There is no packet drop and the server is reachable"
      when: connection is not failed
      delegate_to: localhost

    - debug: msg="The server is not reachable"
      when: connection is failed
      delegate_to: localhost

    - name: Block for unreachable servers
      when: connection is failed
      delegate_to: localhost
      block:
      - set_fact:
          transfer_msg: "Ping test to the server failed because of the possible reason that the server is not in same network or the server is shutdown"
      

    - name: Block for reachable servers
      when: connection is not failed
      block:
      - name: gather latest boot time
        win_shell: (Get-CimInstance -ClassName win32_operatingsystem).LastBootUpTime
        ignore_errors: True
        register: boot_time
        async: 100
        poll: 30

      - name: Getting the boot time and date difference
        win_shell: |
          $a=(Get-CimInstance -ClassName win32_operatingsystem).LastBootUpTime
          $b=date
          ($b-$a).TotalHours
        register: boot_diff

      - set_fact:
          l2_group: "Unix_Team"
          transfer_msg: "Server is in hung state. Transferring the ticket. Please take appropriate actions."
        when: boot_time is failed

      - set_fact:
          l2_group: "Unix_Team"
          transfer_msg: "Server is up but the boot time is less than 8 hours from now. Boot time is {{ boot_time.stdout }} and the server was last rebooted {{ boot_diff.stdout|int }} hours before."
        when: boot_diff.stdout|int < 8

      - debug: msg="{{transfer_msg}}"
        when: boot_diff.stdout|int < 8

      - name: checking event id comments of 6005,6006,6008,1074
        win_shell:
         Get-EventLog -LogName System |? {$_.EventID -in (6005,6006,6008,1074)} | ft TimeGenerated,EventId,Message -AutoSize wrap
        when: boot_diff.stdout|int < 8
        register: event

